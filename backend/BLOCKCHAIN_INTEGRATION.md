# 区块链集成说明

## 概述

本文档说明如何配置和使用后端的区块链集成功能。根据 PRD401 的需求，已将以下功能集成到区块链：

1. **活动信息上链**：创建、更新、删除活动时同步到区块链
2. **签到信息上链**：参赛者签到时记录到区块链，并进行防重校验
3. **投票信息上链**：投票和撤销投票操作同步到区块链

## 配置步骤

### 1. 环境变量配置

在后端项目根目录创建 `.env` 文件或设置环境变量：

```bash
# 区块链私钥（用于签署交易）
BLOCKCHAIN_PRIVATE_KEY=your_private_key_here

# 可选：覆盖 config.yaml 中的配置
BLOCKCHAIN_NETWORK=sepolia
BLOCKCHAIN_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
CHAIN_ID=11155111
```

**重要提示**：
- `BLOCKCHAIN_PRIVATE_KEY` 是必需的，用于签署所有区块链交易
- 私钥应该是部署合约的账户或有权限调用合约的账户
- 请确保私钥安全，不要提交到版本控制系统

### 2. config.yaml 配置

`config.yaml` 文件中已包含区块链相关配置：

```yaml
# 区块链配置
blockchain:
  network: sepolia
  rpc_url: https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY
  chain_id: 11155111

# 智能合约配置
contracts:
  hackathon_platform: "0x3231E959664609b55Ef0bdd483e414B54c510E74"
  hackathon_event: "0x413EfD5873c5bD7D985BF0934d2E00f00315c52c"
  prize_pool: "0x089351624799f31817faB699f7eeb18BC4101759"
  hackathon_nft: "0x0A4CB10f7666142055CE8D955125C05E8A6Ef5ff"
```

### 3. 合约 ABI 文件

确保合约 ABI 文件存在于正确位置：

```
contract/artifacts/contracts/HackathonEvent.sol/HackathonEvent.json
```

这个文件由 Hardhat 编译合约时自动生成。

## 功能说明

### 1. 活动创建上链

**接口**：`POST /admin/hackathons`

**流程**：
1. 主办方在 Admin 平台创建活动
2. 系统验证活动信息
3. 将活动信息写入数据库
4. 调用智能合约 `createEvent` 函数将活动信息上链
5. 记录交易哈希

**注意事项**：
- 活动ID在数据库和区块链中保持一致
- 如果上链失败，整个创建操作会回滚
- 需要确保账户有足够的 ETH 支付 Gas 费

### 2. 活动更新上链

**接口**：`PUT /admin/hackathons/:id`

**流程**：
1. 主办方编辑活动信息
2. 系统验证权限和活动状态
3. 更新数据库中的活动信息
4. 调用智能合约 `updateEvent` 函数更新链上信息
5. 记录交易哈希

**注意事项**：
- 只有活动创建者可以更新活动
- 预备状态的活动可以更新所有信息
- 已发布的活动只能更新阶段信息

### 3. 活动删除上链

**接口**：`DELETE /admin/hackathons/:id`

**流程**：
1. 主办方删除活动
2. 系统验证权限和活动状态
3. 调用智能合约 `deleteEvent` 函数标记删除
4. 软删除数据库记录
5. 记录交易哈希

**注意事项**：
- 只能删除预备状态的活动
- 删除操作会在链上记录，但不会真正删除数据

### 4. 签到上链

**接口**：`POST /arena/hackathons/:id/checkin`

**流程**：
1. 参赛者在 Arena 平台签到
2. 系统验证活动阶段和报名状态
3. 调用智能合约 `checkIns` 函数进行防重校验
4. 如果未重复，调用 `checkIn` 函数记录签到
5. 创建数据库签到记录
6. 记录交易哈希

**防重校验**：
- 系统会先查询链上是否已有签到记录
- 如果已签到，拒绝重复签到
- 确保每个参赛者在每个活动中只能签到一次

### 5. 投票上链

**接口**：`POST /arena/votes`

**流程**：
1. 参赛者对作品投票
2. 系统验证活动阶段和签到状态
3. 调用智能合约 `vote` 函数记录投票
4. 创建数据库投票记录
5. 记录交易哈希

**注意事项**：
- 必须先完成签到才能投票
- 每个参赛者对每个作品只能投一次票

### 6. 投票撤销上链

**接口**：`DELETE /arena/votes/:submissionId`

**流程**：
1. 参赛者撤销投票
2. 系统验证活动阶段和投票记录
3. 调用智能合约 `revokeVote` 函数记录撤销
4. 删除数据库投票记录
5. 记录交易哈希

**注意事项**：
- 只能在投票阶段撤销投票
- 撤销操作也会记录在链上

## 错误处理

### 区块链服务初始化失败

如果区块链服务初始化失败（如 RPC 连接失败、私钥错误等），系统会：
- 记录错误日志
- 对于创建、更新、删除活动：操作失败，返回错误
- 对于签到、投票：继续执行数据库操作（降级处理）

### 交易失败

如果区块链交易失败（如 Gas 不足、合约调用失败等），系统会：
- 返回详细的错误信息
- 对于创建、更新、删除活动：回滚数据库操作
- 对于签到、投票：返回错误，不创建数据库记录

### Gas 费不足

如果账户 ETH 余额不足以支付 Gas 费：
- 系统会返回 "Gas 费不足" 错误
- 需要向账户充值 ETH

## 测试

### 本地测试

1. 启动本地区块链节点（如 Hardhat Network）：
```bash
cd contract
npx hardhat node
```

2. 部署合约到本地网络：
```bash
npx hardhat run scripts/deploy.js --network localhost
```

3. 更新 `config.yaml` 中的合约地址和 RPC URL

4. 设置环境变量：
```bash
export BLOCKCHAIN_PRIVATE_KEY=your_test_private_key
```

5. 启动后端服务：
```bash
cd backend
go run main.go
```

### Sepolia 测试网测试

1. 确保合约已部署到 Sepolia 测试网

2. 获取 Sepolia 测试网 ETH（从水龙头）

3. 配置 `config.yaml` 使用 Sepolia 网络

4. 设置私钥环境变量

5. 启动后端服务并测试

## 监控和日志

系统会在以下情况输出日志：

- 区块链服务初始化成功/失败
- 交易发送成功，输出交易哈希
- 交易失败，输出错误信息
- 防重校验结果

日志格式示例：
```
活动创建成功，交易哈希: 0x1234567890abcdef...
签到成功，交易哈希: 0xabcdef1234567890...
投票成功，交易哈希: 0x9876543210fedcba...
```

## 安全建议

1. **私钥管理**：
   - 使用环境变量存储私钥
   - 不要将私钥提交到版本控制系统
   - 生产环境使用专用的服务账户

2. **权限控制**：
   - 确保只有授权用户可以执行链上操作
   - 验证用户身份和权限

3. **Gas 费管理**：
   - 监控账户余额
   - 设置 Gas 价格上限
   - 考虑使用 Gas Station 优化 Gas 费

4. **错误处理**：
   - 实现完善的错误处理机制
   - 提供用户友好的错误提示
   - 记录详细的错误日志

## 未来扩展

根据 PRD401，以下功能待实现：

1. **NFT 发放**：主办方为签到参赛者发放 NFT
2. **奖金托管**：创建活动时托管奖金到智能合约
3. **奖金分发**：活动结束后自动分发奖金
4. **赞助商资金管理**：赞助商资金托管和分发
5. **活动信息验证**：验证链上和链下数据一致性
6. **资金链路查询**：查询所有资金流向

这些功能需要额外的智能合约支持和后端服务实现。

## 常见问题

### Q: 如何获取私钥？
A: 可以使用 MetaMask 导出私钥，或使用 Hardhat 生成测试账户。

### Q: 交易确认需要多长时间？
A: 取决于网络拥堵情况，Sepolia 测试网通常 15-30 秒。

### Q: 如何查看交易详情？
A: 使用交易哈希在区块链浏览器（如 Etherscan）查看。

### Q: Gas 费大概需要多少？
A: 取决于操作类型和网络状况，建议账户保持至少 0.1 ETH。

### Q: 如果区块链服务不可用怎么办？
A: 系统会降级处理，继续执行数据库操作，但会记录错误日志。
