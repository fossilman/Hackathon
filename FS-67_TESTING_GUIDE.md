# FS-67 Gas 费预估功能测试指南

## 测试前准备

### 1. 启动后端服务
```bash
cd backend
go run main.go
```

### 2. 启动前端服务
```bash
cd frontend/arena
npm run dev
```

### 3. 准备测试账户
- 确保有 MetaMask 钱包
- 准备两个测试账户：
  - 账户 A：余额充足（> 0.01 ETH）
  - 账户 B：余额不足（< 0.001 ETH）

## 测试场景

### 场景 1: 签到功能 - 余额充足

**前置条件**:
- 使用账户 A 登录
- 活动状态为"签到"阶段
- 用户已报名但未签到

**测试步骤**:
1. 进入活动详情页
2. 点击"签到"按钮
3. 观察 Gas 费预估模态框显示

**预期结果**:
- ✅ 模态框显示"签到 Gas 费预估"标题
- ✅ 显示"正在预估 Gas 费用..."加载状态
- ✅ 加载完成后显示：
  - Gas 限制（如：50000）
  - Gas 价格（如：20.00 Gwei）
  - 预计费用（如：0.001000 ETH）
  - 您的余额（如：5.000000 ETH）
- ✅ 显示绿色提示："余额充足，可以执行操作"
- ✅ "确认"按钮可点击
- ✅ 点击"确认"后执行签到，显示"签到成功"提示

### 场景 2: 签到功能 - 余额不足

**前置条件**:
- 使用账户 B 登录
- 活动状态为"签到"阶段
- 用户已报名但未签到

**测试步骤**:
1. 进入活动详情页
2. 点击"签到"按钮
3. 观察 Gas 费预估模态框显示

**预期结果**:
- ✅ 模态框正常显示 Gas 费信息
- ✅ 显示红色警告："余额不足"
- ✅ 显示充值提示："需要充值至少 X ETH"
- ✅ "确认"按钮被禁用（灰色，无法点击）
- ✅ 用户余额显示为红色
- ✅ 点击"取消"可关闭模态框

### 场景 3: 投票功能 - 余额充足

**前置条件**:
- 使用账户 A 登录
- 活动状态为"投票"阶段
- 有可投票的作品

**测试步骤**:
1. 进入作品列表页
2. 点击某个作品的"投票"按钮
3. 观察 Gas 费预估模态框显示

**预期结果**:
- ✅ 模态框显示"投票 Gas 费预估"标题
- ✅ 正常显示 Gas 费信息
- ✅ 显示"余额充足"提示
- ✅ "确认"按钮可点击
- ✅ 点击"确认"后执行投票，显示"投票成功"提示

### 场景 4: 撤销投票功能 - 余额充足

**前置条件**:
- 使用账户 A 登录
- 活动状态为"投票"阶段
- 已经投票给某个作品

**测试步骤**:
1. 进入作品列表页
2. 找到已投票的作品
3. 点击"撤回投票"按钮
4. 观察 Gas 费预估模态框显示

**预期结果**:
- ✅ 模态框显示"撤销投票 Gas 费预估"标题
- ✅ 正常显示 Gas 费信息
- ✅ 显示"余额充足"提示
- ✅ "确认"按钮可点击
- ✅ 点击"确认"后撤销投票，显示"撤回投票成功"提示

### 场景 5: 网络异常处理

**测试步骤**:
1. 断开区块链节点连接或使用无效的 RPC URL
2. 尝试触发 Gas 费预估

**预期结果**:
- ✅ 显示错误提示："Gas 费预估失败"
- ✅ 显示具体错误信息
- ✅ "确认"按钮被禁用
- ✅ 用户可以点击"取消"关闭模态框

### 场景 6: 取消操作

**测试步骤**:
1. 触发任意 Gas 费预估（签到、投票、撤销投票）
2. 在模态框显示后点击"取消"按钮

**预期结果**:
- ✅ 模态框关闭
- ✅ 不执行实际操作（签到/投票/撤销投票）
- ✅ 页面状态不变

### 场景 7: 国际化测试

**测试步骤**:
1. 切换语言为中文
2. 触发 Gas 费预估，检查所有文本
3. 切换语言为英文
4. 再次触发 Gas 费预估，检查所有文本

**预期结果**:
- ✅ 中文界面所有文本正确显示中文
- ✅ 英文界面所有文本正确显示英文
- ✅ 数字和金额格式正确
- ✅ 按钮文本正确切换

### 场景 8: 加载状态测试

**测试步骤**:
1. 模拟慢速网络（浏览器 DevTools -> Network -> Slow 3G）
2. 触发 Gas 费预估

**预期结果**:
- ✅ 立即显示加载动画
- ✅ 显示"正在预估 Gas 费用..."文本
- ✅ 加载期间无法点击"确认"按钮
- ✅ 加载完成后正常显示结果

## API 测试

### 使用 curl 测试

#### 1. 预估签到 Gas 费
```bash
curl -X GET "http://localhost:8080/api/v1/arena/hackathons/1/estimate-checkin-gas" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应**:
```json
{
  "gas_limit": 50000,
  "gas_price": "20000000000",
  "gas_price_gwei": "20.00",
  "total_cost": "1000000000000000",
  "total_cost_eth": "0.001000",
  "user_balance": "5000000000000000000",
  "user_balance_eth": "5.000000",
  "is_sufficient": true,
  "shortfall_eth": "0"
}
```

#### 2. 预估投票 Gas 费
```bash
curl -X GET "http://localhost:8080/api/v1/arena/submissions/1/estimate-vote-gas" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 3. 预估撤销投票 Gas 费
```bash
curl -X GET "http://localhost:8080/api/v1/arena/submissions/1/estimate-revoke-vote-gas" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 性能测试

### 1. Gas 费预估响应时间
**目标**: < 3 秒

**测试方法**:
```bash
time curl -X GET "http://localhost:8080/api/v1/arena/hackathons/1/estimate-checkin-gas" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. 并发测试
**目标**: 支持 10 个并发请求

**测试方法**: 使用 Apache Bench
```bash
ab -n 100 -c 10 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:8080/api/v1/arena/hackathons/1/estimate-checkin-gas"
```

## 边界条件测试

### 1. 余额刚好等于 Gas 费
- 准备账户余额 = 预估 Gas 费
- 预期：显示"余额充足"，可以确认

### 2. 余额略小于 Gas 费
- 准备账户余额 = 预估 Gas 费 - 0.000001 ETH
- 预期：显示"余额不足"，禁用确认按钮

### 3. 活动未上链
- 测试未上链的活动
- 预期：返回错误"活动未上链"

### 4. 用户未登录
- 未登录状态下调用 API
- 预期：返回 401 Unauthorized

### 5. 无效的活动 ID
- 使用不存在的活动 ID
- 预期：返回 404 活动不存在

## 检查清单

### 功能完整性
- [ ] 签到 Gas 费预估正常工作
- [ ] 投票 Gas 费预估正常工作
- [ ] 撤销投票 Gas 费预估正常工作
- [ ] 余额充足时可以执行操作
- [ ] 余额不足时禁止操作

### 用户体验
- [ ] 加载状态友好
- [ ] 错误提示清晰
- [ ] 取消操作流畅
- [ ] 国际化完整

### 代码质量
- [ ] 无 linter 错误
- [ ] 无 console 错误
- [ ] API 响应正常
- [ ] 性能符合要求

## 问题记录

如果发现问题，请按以下格式记录：

### 问题 1: [问题标题]
- **严重程度**: 高/中/低
- **复现步骤**: 
  1. 步骤 1
  2. 步骤 2
- **预期结果**: 
- **实际结果**: 
- **截图**: 
- **环境**: 
  - 浏览器: 
  - 操作系统: 
  - 网络: 

## 测试报告模板

### 测试执行情况
- 测试日期: YYYY-MM-DD
- 测试人员: 
- 测试环境: 
  - 后端: http://localhost:8080
  - 前端: http://localhost:5173
  - 区块链网络: Sepolia

### 测试结果汇总
- 测试场景总数: 8
- 通过场景数: 
- 失败场景数: 
- 阻塞问题数: 
- 非阻塞问题数: 

### 场景测试结果
| 场景 | 状态 | 备注 |
|------|------|------|
| 场景 1: 签到 - 余额充足 | ✅/❌ | |
| 场景 2: 签到 - 余额不足 | ✅/❌ | |
| 场景 3: 投票 - 余额充足 | ✅/❌ | |
| 场景 4: 撤销投票 - 余额充足 | ✅/❌ | |
| 场景 5: 网络异常处理 | ✅/❌ | |
| 场景 6: 取消操作 | ✅/❌ | |
| 场景 7: 国际化测试 | ✅/❌ | |
| 场景 8: 加载状态测试 | ✅/❌ | |

### 结论
- [ ] 功能符合预期，可以发布
- [ ] 存在非阻塞问题，建议修复后发布
- [ ] 存在阻塞问题，不建议发布

---

**测试文档版本**: v1.0  
**创建日期**: 2025-12-26  
**对应 Issue**: FS-67
